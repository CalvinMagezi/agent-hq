"use strict";var M=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var X=(n,e)=>{for(var t in e)M(n,t,{get:e[t],enumerable:!0})},Y=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Q(e))!j.call(n,i)&&i!==t&&M(n,i,{get:()=>e[i],enumerable:!(s=z(e,i))||s.enumerable});return n};var J=n=>Y(M({},"__esModule",{value:!0}),n);var oe={};X(oe,{default:()=>P});module.exports=J(oe);var A=require("obsidian");var h=[".obsidian/","_embeddings/",".git/",".DS_Store","node_modules/",".sync-conflict-",".trash/"],D=["e2e-aes256gcm","delta-sync","conflict-resolve"],R="0.1.0";var c=globalThis.crypto.subtle;function $(n){let e=new Uint8Array(n),t="";for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(e[s]);return btoa(t)}function K(n){let e=atob(n),t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}function d(n){return new TextEncoder().encode(n)}function se(n){return new TextDecoder().decode(n)}async function g(n,e){let t=await c.importKey("raw",d(n),"PBKDF2",!1,["deriveKey"]);return c.deriveKey({name:"PBKDF2",salt:d(e),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function y(n){let e=await c.exportKey("raw",n),t=await c.digest("SHA-256",e),s=new Uint8Array(t),i="";for(let a=0;a<s.length;a++)i+=s[a].toString(16).padStart(2,"0");return i.slice(0,32)}async function N(n,e){let t=globalThis.crypto.getRandomValues(new Uint8Array(12)),s=await c.encrypt({name:"AES-GCM",iv:t},e,d(n));return{v:1,nonce:$(t.buffer),ciphertext:$(s)}}async function k(n,e){let t=K(n.nonce),s=K(n.ciphertext),i=await c.decrypt({name:"AES-GCM",iv:t},e,s);return se(i)}async function _(n,e){let t=`${n}:${e}`,s=await c.digest("SHA-256",d(t)),i=new Uint8Array(s),a="";for(let r=0;r<i.length;r++)a+=i[r].toString(16).padStart(2,"0");return a.slice(0,16)}function H(){let n=globalThis.crypto.getRandomValues(new Uint8Array(4)),e=(n[0]<<24|n[1]<<16|n[2]<<8|n[3])>>>0;return String(e%1e6).padStart(6,"0")}async function l(n){let e=await c.digest("SHA-256",d(n)),t=new Uint8Array(e),s="";for(let i=0;i<t.length;i++)s+=t[i].toString(16).padStart(2,"0");return s}var ge=globalThis.crypto.subtle;var ne=new Set(["hello","hello-ack","ping","pong","error","pair-request","pair-confirm"]);async function O(n,e){if(!e||ne.has(n.type))return{encrypted:!1,payload:n};let t=JSON.stringify(n);return{encrypted:!0,payload:await N(t,e)}}async function F(n,e){if(!n.encrypted)return n.payload;if(!e)throw new Error("Received encrypted message but no decryption key is set");let t=n.payload,s=await k(t,e);return JSON.parse(s)}function u(n){return JSON.stringify(n)}function V(n){return JSON.parse(n)}var S=require("obsidian");var v=class{constructor(e,t,s=300){this.app=e;this.deviceId=t,this.debounceMs=s}eventRefs=[];debounceTimers=new Map;debounceMs;callback=null;deviceId;changeCounter=0;suppressedPaths=new Set;start(e){this.callback=e,this.eventRefs.push(this.app.vault.on("create",t=>{t instanceof Object&&"extension"in t&&this.handleChange(t,"create")})),this.eventRefs.push(this.app.vault.on("modify",t=>{t instanceof Object&&"extension"in t&&this.handleChange(t,"modify")})),this.eventRefs.push(this.app.vault.on("delete",t=>{t instanceof Object&&"extension"in t&&this.handleDelete(t)})),this.eventRefs.push(this.app.vault.on("rename",(t,s)=>{t instanceof Object&&"extension"in t&&this.handleRename(t,s)}))}stop(){for(let e of this.eventRefs)this.app.vault.offref(e);this.eventRefs=[];for(let e of this.debounceTimers.values())clearTimeout(e);this.debounceTimers.clear(),this.callback=null}suppressPath(e){this.suppressedPaths.add(e)}unsuppressPath(e){this.suppressedPaths.delete(e)}handleChange(e,t){this.shouldSync(e.path)&&(this.suppressedPaths.has(e.path)||this.debounce(e.path,async()=>{try{let s=await this.app.vault.read(e),i=await l(s);this.emitChange({changeId:++this.changeCounter,path:e.path,changeType:t,contentHash:i,size:s.length,mtime:e.stat.mtime,detectedAt:Date.now(),deviceId:this.deviceId})}catch{}}))}handleDelete(e){this.shouldSync(e.path)&&(this.suppressedPaths.has(e.path)||this.emitChange({changeId:++this.changeCounter,path:e.path,changeType:"delete",contentHash:null,size:null,mtime:null,detectedAt:Date.now(),deviceId:this.deviceId}))}handleRename(e,t){!this.shouldSync(e.path)&&!this.shouldSync(t)||this.suppressedPaths.has(e.path)||this.debounce(e.path,async()=>{try{let s=await this.app.vault.read(e),i=await l(s);this.emitChange({changeId:++this.changeCounter,path:e.path,oldPath:t,changeType:"rename",contentHash:i,size:s.length,mtime:e.stat.mtime,detectedAt:Date.now(),deviceId:this.deviceId})}catch{}})}shouldSync(e){if(!e.endsWith(".md"))return!1;for(let t of h)if(e.includes(t))return!1;return!0}debounce(e,t){let s=this.debounceTimers.get(e);s&&clearTimeout(s),this.debounceTimers.set(e,setTimeout(()=>{this.debounceTimers.delete(e),t()},this.debounceMs))}emitChange(e){this.callback&&this.callback(e)}};var f=class{constructor(e){this.settings=e}ws=null;encryptionKey=null;vaultId="";pingInterval=null;reconnectTimer=null;reconnectDelay=1e3;intentionallyClosed=!1;onMessage=null;onStatus=null;async init(){if(this.settings.enableE2E&&this.settings.encryptionPassphrase){let e="agent-hq-vault-sync-v1";this.encryptionKey=await g(this.settings.encryptionPassphrase,e),this.vaultId=await y(this.encryptionKey)}else if(this.encryptionKey=null,this.settings.encryptionPassphrase){let t=await g(this.settings.encryptionPassphrase,"agent-hq-vault-sync-v1");this.vaultId=await y(t)}else this.vaultId="unencrypted-vault"}onMessages(e){this.onMessage=e}onStatusChange(e){this.onStatus=e}async connect(){if(!this.ws){this.intentionallyClosed=!1,await this.init(),this.emitStatus("connecting");try{this.ws=new WebSocket(this.settings.serverUrl),this.ws.onopen=()=>{this.reconnectDelay=1e3,this.sendHello(),this.startPing()},this.ws.onmessage=e=>{this.handleRawMessage(e.data)},this.ws.onclose=()=>{this.cleanup(),this.intentionallyClosed||(this.emitStatus("disconnected"),this.scheduleReconnect())},this.ws.onerror=()=>{this.emitStatus("error")}}catch{this.emitStatus("error"),this.scheduleReconnect()}}}disconnect(){this.intentionallyClosed=!0,this.cleanup(),this.emitStatus("disconnected")}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let t=await O(e,this.encryptionKey);this.ws.send(u(t))}async pushChange(e){let t={type:"delta-push",fromDeviceId:this.settings.deviceId,change:e};await this.send(t)}async requestIndex(e,t=500){await this.send({type:"index-request",sinceChangeId:e,batchSize:t})}async requestFile(e,t,s){await this.send({type:"file-request",path:e,contentHash:t,targetDeviceId:s,fromDeviceId:this.settings.deviceId})}get isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}get currentVaultId(){return this.vaultId}sendHello(){let e={type:"hello",protocolVersion:1,deviceId:this.settings.deviceId,deviceName:this.settings.deviceName||"Unknown Device",vaultId:this.vaultId,capabilities:[...D],clientVersion:R,deviceToken:this.settings.deviceToken},t=u({encrypted:!1,payload:e});this.ws?.send(t)}async handleRawMessage(e){try{let t=V(e),s=await F(t,this.encryptionKey);s.type==="hello-ack"&&(this.settings.deviceToken=s.assignedToken,this.emitStatus("synced")),this.onMessage&&this.onMessage(s)}catch(t){this.settings.debug&&console.error("[vault-sync] Failed to process message:",t)}}startPing(){this.pingInterval=setInterval(()=>{if(this.ws?.readyState===WebSocket.OPEN){let e=u({encrypted:!1,payload:{type:"ping",timestamp:Date.now()}});this.ws.send(e)}},3e4)}cleanup(){if(this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws){try{this.ws.close()}catch{}this.ws=null}}scheduleReconnect(){this.intentionallyClosed||(this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect()},this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,3e4))}emitStatus(e){this.onStatus&&this.onStatus(e)}};var p=class{constructor(e){this.app=e}async readFile(e){try{return await this.app.vault.adapter.read(e)}catch{return null}}async writeFile(e,t){let s=e.substring(0,e.lastIndexOf("/"));return s&&(await this.app.vault.adapter.exists(s)||await this.app.vault.adapter.mkdir(s)),await this.app.vault.adapter.write(e,t),l(t)}async deleteFile(e){if(await this.app.vault.adapter.exists(e)){let s=this.app.vault.getAbstractFileByPath(e);s&&await this.app.vault.delete(s)}}async renameFile(e,t){let s=this.app.vault.getAbstractFileByPath(e);s&&await this.app.vault.rename(s,t)}async exists(e){return this.app.vault.adapter.exists(e)}async getFileHash(e){let t=await this.readFile(e);return t===null?null:l(t)}async getFileStat(e){try{let t=await this.app.vault.adapter.stat(e);return t?{mtime:t.mtime,size:t.size}:null}catch{return null}}};var m=class{constructor(e,t){this.app=e;this.settings=t;this.fileAdapter=new p(e)}fileAdapter;conflicts=[];async checkAndResolve(e,t){if(!t)return{isConflict:!1,shouldApply:!0};if(t===e.contentHash)return{isConflict:!1,shouldApply:!1};if(e.deviceId!==this.settings.deviceId){let s={path:e.path,localHash:t,remoteHash:e.contentHash,remoteDeviceId:e.deviceId,detectedAt:Date.now()};return this.resolveConflict(s,e)}return{isConflict:!1,shouldApply:!0}}async resolveConflict(e,t){switch(this.settings.conflictStrategy){case"newer-wins":return this.resolveNewerWins(e,t);case"merge-frontmatter":return this.resolveNewerWins(e,t);case"manual":return this.deferToManual(e);default:return this.resolveNewerWins(e,t)}}async resolveNewerWins(e,t){let i=(await this.fileAdapter.getFileStat(e.path))?.mtime??0;return(t.mtime??0)>=i?(await this.preserveLoserCopy(e.path,this.settings.deviceId??"local"),{isConflict:!0,shouldApply:!0}):(this.conflicts.push(e),{isConflict:!0,shouldApply:!1})}async deferToManual(e){return await this.preserveLoserCopy(e.path,e.remoteDeviceId),this.conflicts.push(e),{isConflict:!0,shouldApply:!1}}async preserveLoserCopy(e,t){let s=await this.fileAdapter.readFile(e);if(!s)return e;let i=e.endsWith(".md")?".md":"",a=i?e.slice(0,-i.length):e,r=this.formatTimestamp(Date.now()),U=`${a}.sync-conflict-${r}-${t.slice(0,8)}${i}`;return await this.fileAdapter.writeFile(U,s),U}formatTimestamp(e){let t=new Date(e),s=i=>i.toString().padStart(2,"0");return`${t.getFullYear()}${s(t.getMonth()+1)}${s(t.getDate())}-${s(t.getHours())}${s(t.getMinutes())}${s(t.getSeconds())}`}getConflicts(){return[...this.conflicts]}clearConflict(e){this.conflicts=this.conflicts.filter(t=>t.path!==e)}get conflictCount(){return this.conflicts.length}};var C=class{constructor(e,t){this.app=e;this.settings=t;this.transport=new f(t),this.changeDetector=new v(e,t.deviceId),this.fileAdapter=new p(e),this.conflictHandler=new m(e,t),this.fileHashes=new Map(Object.entries(t.fileHashes??{}))}transport;changeDetector;fileAdapter;conflictHandler;offlineQueue=[];fileHashes;connectedDevices=[];_status="disconnected";statusCallbacks=[];pendingFileRequests=new Map;async start(){if(!this.settings.serverUrl||!this.settings.deviceId){this.settings.debug&&console.log("[vault-sync] Cannot start: missing serverUrl or deviceId");return}this.transport.onMessages(e=>this.handleServerMessage(e)),this.transport.onStatusChange(e=>this.setStatus(e)),this.changeDetector.start(e=>this.handleLocalChange(e)),await this.transport.connect()}async stop(){this.changeDetector.stop(),this.transport.disconnect(),this.setStatus("disconnected"),this.settings.fileHashes=Object.fromEntries(this.fileHashes)}async triggerSync(){if(!this.transport.isConnected){new S.Notice("Not connected to sync server");return}this.setStatus("syncing");for(let e of this.offlineQueue)await this.transport.pushChange(e);this.offlineQueue=[],await this.transport.requestIndex(this.settings.lastSyncChangeId??0),new S.Notice("Sync triggered")}get status(){return this._status}onStatusChange(e){this.statusCallbacks.push(e)}getConnectedDevices(){return[...this.connectedDevices]}get conflictCount(){return this.conflictHandler.conflictCount}getConflicts(){return this.conflictHandler.getConflicts()}async handleLocalChange(e){e.contentHash?this.fileHashes.set(e.path,e.contentHash):e.changeType==="delete"&&this.fileHashes.delete(e.path),this.transport.isConnected?await this.transport.pushChange(e):(this.offlineQueue.push(e),this.offlineQueue.length>1e3&&this.offlineQueue.shift())}async handleServerMessage(e){switch(e.type){case"hello-ack":await this.handleHelloAck(e);break;case"delta-push":await this.handleDeltaPush(e);break;case"index-response":await this.handleIndexResponse(e);break;case"file-response":this.handleFileResponse(e);break;case"device-list":this.handleDeviceList(e);break;case"error":this.settings.debug&&console.error("[vault-sync] Server error:",e);break}}async handleHelloAck(e){if(this.connectedDevices=e.connectedDevices,e.assignedToken&&(this.settings.deviceToken=e.assignedToken),this.offlineQueue.length>0){this.setStatus("syncing");for(let t of this.offlineQueue)await this.transport.pushChange(t);this.offlineQueue=[]}await this.transport.requestIndex(this.settings.lastSyncChangeId??0),this.setStatus("synced")}async handleDeltaPush(e){let t=e.change;t.deviceId!==this.settings.deviceId&&(this.shouldIgnore(t.path)||await this.applyRemoteChange(t))}async handleIndexResponse(e){if(e.changes.length!==0){this.setStatus("syncing");for(let t of e.changes)t.deviceId!==this.settings.deviceId&&(this.shouldIgnore(t.path)||await this.applyRemoteChange(t));this.settings.lastSyncChangeId=e.latestChangeId,e.hasMore?await this.transport.requestIndex(e.latestChangeId):this.setStatus("synced")}}handleFileResponse(e){let t=`${e.path}:${e.contentHash}`,s=this.pendingFileRequests.get(t);s&&(clearTimeout(s.timer),s.resolve(atob(e.content)),this.pendingFileRequests.delete(t))}handleDeviceList(e){this.connectedDevices=e.devices.filter(t=>t.status==="online"&&t.deviceId!==this.settings.deviceId).map(t=>t.deviceId)}async applyRemoteChange(e){try{switch(e.changeType){case"create":case"modify":await this.applyCreateOrModify(e);break;case"delete":await this.applyDelete(e);break;case"rename":await this.applyRename(e);break}}catch(t){this.settings.debug&&console.error(`[vault-sync] Failed to apply change to ${e.path}:`,t)}}async applyCreateOrModify(e){let t=this.fileHashes.get(e.path)??null,{isConflict:s,shouldApply:i}=await this.conflictHandler.checkAndResolve(e,t);if(!i)return;let a=await this.requestFileContent(e.path,e.contentHash,e.deviceId);if(a===null){this.settings.debug&&console.warn(`[vault-sync] Could not get content for ${e.path}`);return}this.changeDetector.suppressPath(e.path);try{let r=await this.fileAdapter.writeFile(e.path,a);this.fileHashes.set(e.path,r)}finally{setTimeout(()=>{this.changeDetector.unsuppressPath(e.path)},500)}s&&new S.Notice(`Sync conflict resolved for ${e.path}`)}async applyDelete(e){let t=this.fileHashes.get(e.path)??null;if(t&&e.contentHash&&t!==e.contentHash){this.settings.debug&&console.log(`[vault-sync] Skipping delete of ${e.path} \u2014 locally modified`);return}this.changeDetector.suppressPath(e.path);try{await this.fileAdapter.deleteFile(e.path),this.fileHashes.delete(e.path)}finally{setTimeout(()=>{this.changeDetector.unsuppressPath(e.path)},500)}}async applyRename(e){if(e.oldPath){this.changeDetector.suppressPath(e.path),this.changeDetector.suppressPath(e.oldPath);try{await this.fileAdapter.renameFile(e.oldPath,e.path);let t=this.fileHashes.get(e.oldPath);t&&(this.fileHashes.delete(e.oldPath),this.fileHashes.set(e.path,t))}finally{setTimeout(()=>{this.changeDetector.unsuppressPath(e.path),this.changeDetector.unsuppressPath(e.oldPath)},500)}}}requestFileContent(e,t,s){return new Promise(i=>{let a=`${e}:${t}`,r=setTimeout(()=>{this.pendingFileRequests.delete(a),i(null)},1e4);this.pendingFileRequests.set(a,{resolve:i,timer:r}),this.transport.requestFile(e,t,s)})}shouldIgnore(e){for(let t of h)if(e.includes(t))return!0;return!e.endsWith(".md")}setStatus(e){if(this._status!==e){this._status=e;for(let t of this.statusCallbacks)t(e)}}};var ie={disconnected:"\u2716",connecting:"\u21BB",syncing:"\u21C4",synced:"\u2714",error:"\u26A0"},ae={disconnected:"Disconnected",connecting:"Connecting...",syncing:"Syncing...",synced:"Synced",error:"Sync Error"},w=class{constructor(e,t){this.syncEngine=t;this.el=e.addStatusBarItem(),this.el.addClass("vault-sync-status"),this.update("disconnected"),t.onStatusChange(s=>this.update(s))}el;update(e){let t=ie[e],s=ae[e],i=this.syncEngine.conflictCount,a=`${t} ${s}`;i>0&&(a+=` (${i} conflict${i>1?"s":""})`),this.el.setText(a),this.el.className=`vault-sync-status vault-sync-status-${e}`}};var o=require("obsidian"),E=class extends o.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"Connection"}),new o.Setting(e).setName("Server URL").setDesc("WebSocket URL of the sync relay server (ws:// or wss://)").addText(t=>t.setPlaceholder("ws://127.0.0.1:18800").setValue(this.plugin.settings.serverUrl).onChange(async s=>{this.plugin.settings.serverUrl=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Device Name").setDesc("A human-readable name for this device").addText(t=>t.setPlaceholder("My MacBook").setValue(this.plugin.settings.deviceName).onChange(async s=>{this.plugin.settings.deviceName=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Security"}),new o.Setting(e).setName("Enable E2E Encryption").setDesc("Encrypt all sync data so the relay server never sees plaintext").addToggle(t=>t.setValue(this.plugin.settings.enableE2E).onChange(async s=>{this.plugin.settings.enableE2E=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Encryption Passphrase").setDesc("Shared passphrase for E2E encryption. All devices must use the same passphrase.").addText(t=>{t.inputEl.type="password",t.setPlaceholder("Enter passphrase").setValue(this.plugin.settings.encryptionPassphrase).onChange(async s=>{this.plugin.settings.encryptionPassphrase=s,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"Sync Behavior"}),new o.Setting(e).setName("Auto-sync").setDesc("Automatically start syncing when Obsidian opens").addToggle(t=>t.setValue(this.plugin.settings.autoSync).onChange(async s=>{this.plugin.settings.autoSync=s,await this.plugin.saveSettings()})),new o.Setting(e).setName("Conflict Strategy").setDesc("How to resolve conflicts when the same file is modified on two devices").addDropdown(t=>t.addOption("newer-wins","Newer wins").addOption("merge-frontmatter","Merge frontmatter").addOption("manual","Ask me").setValue(this.plugin.settings.conflictStrategy).onChange(async s=>{this.plugin.settings.conflictStrategy=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Advanced"}),new o.Setting(e).setName("Debug Logging").setDesc("Log sync events to the developer console").addToggle(t=>t.setValue(this.plugin.settings.debug).onChange(async s=>{this.plugin.settings.debug=s,await this.plugin.saveSettings()})),this.plugin.settings.deviceId&&new o.Setting(e).setName("Device ID").setDesc("Unique identifier for this device (auto-generated)").addText(t=>{t.setValue(this.plugin.settings.deviceId),t.inputEl.readOnly=!0,t.inputEl.style.fontFamily="monospace",t.inputEl.style.fontSize="12px"})}};var T=require("obsidian"),I=class extends T.Modal{conflicts;onResolve;constructor(e,t,s){super(e),this.conflicts=t,this.onResolve=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("vault-sync-conflict-modal"),e.createEl("h2",{text:"Sync Conflicts"}),this.conflicts.length===0){e.createEl("p",{text:"No unresolved conflicts."});return}e.createEl("p",{text:`${this.conflicts.length} file${this.conflicts.length>1?"s have":" has"} conflicting changes from other devices.`});for(let t of this.conflicts){let s=e.createDiv("vault-sync-conflict-item");s.createEl("h4",{text:t.path}),s.createEl("p",{text:`Local: ${t.localHash.slice(0,8)}... | Remote: ${t.remoteHash.slice(0,8)}... (from ${t.remoteDeviceId.slice(0,8)})`,cls:"vault-sync-conflict-hashes"}),new T.Setting(s).addButton(i=>i.setButtonText("Keep Local").onClick(()=>{this.onResolve(t.path,"keep-local"),s.remove()})).addButton(i=>i.setButtonText("Keep Remote").setCta().onClick(()=>{this.onResolve(t.path,"keep-remote"),s.remove()})).addButton(i=>i.setButtonText("Keep Both").onClick(()=>{this.onResolve(t.path,"keep-both"),s.remove()}))}}onClose(){this.contentEl.empty()}};var x=require("obsidian");var b=class extends x.Modal{connectedDevices;pairingCode=null;constructor(e,t){super(e),this.connectedDevices=t}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("vault-sync-device-modal"),e.createEl("h2",{text:"Paired Devices"}),this.connectedDevices.length===0)e.createEl("p",{text:"No other devices currently connected.",cls:"vault-sync-no-devices"});else{let i=e.createEl("ul",{cls:"vault-sync-device-list"});for(let a of this.connectedDevices){let r=i.createEl("li");r.createSpan({text:`${a.slice(0,8)}...`,cls:"vault-sync-device-id"}),r.createSpan({text:" (online)",cls:"vault-sync-device-status-online"})}}e.createEl("h3",{text:"Pair New Device"}),e.createEl("p",{text:"Generate a pairing code and enter it on the new device."});let t=e.createDiv("vault-sync-pairing");new x.Setting(t).setName("Pairing Code").setDesc("Share this code with the device you want to pair").addButton(i=>i.setButtonText("Generate Code").setCta().onClick(()=>{this.pairingCode=H(),s.setText(this.pairingCode),s.addClass("vault-sync-pairing-code-visible")}));let s=t.createDiv("vault-sync-pairing-code");s.setText("------")}onClose(){this.contentEl.empty(),this.pairingCode=null}};var B={serverUrl:"ws://127.0.0.1:18800",deviceName:"",encryptionPassphrase:"",autoSync:!0,syncIntervalMs:3e4,conflictStrategy:"merge-frontmatter",enableE2E:!0,debug:!1};var re='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',P=class extends A.Plugin{settings=B;syncEngine;statusBar;async onload(){if(await this.loadSettings(),!this.settings.deviceId){let e=typeof require<"u"?require("os").hostname?.()??"obsidian-device":"obsidian-mobile",t=this.app.vault.getName();this.settings.deviceId=await _(e,t),await this.saveSettings()}this.syncEngine=new C(this.app,this.settings),this.addSettingTab(new E(this.app,this)),this.statusBar=new w(this,this.syncEngine),(0,A.addIcon)("vault-sync",re),this.addRibbonIcon("vault-sync","Vault Sync",()=>{this.syncEngine.triggerSync()}),this.addCommand({id:"sync-now",name:"Sync now",callback:()=>this.syncEngine.triggerSync()}),this.addCommand({id:"view-conflicts",name:"View sync conflicts",callback:()=>{let e=this.syncEngine.getConflicts();new I(this.app,e,(t,s)=>{this.settings.debug&&console.log(`[vault-sync] Conflict resolved: ${t} \u2192 ${s}`)}).open()}}),this.addCommand({id:"manage-devices",name:"Manage paired devices",callback:()=>{new b(this.app,this.syncEngine.getConnectedDevices()).open()}}),this.settings.autoSync&&this.settings.serverUrl&&this.registerInterval(window.setTimeout(()=>{this.syncEngine.start().catch(e=>{this.settings.debug&&console.error("[vault-sync] Auto-start failed:",e)})},2e3))}async onunload(){await this.syncEngine.stop(),await this.saveSettings()}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
